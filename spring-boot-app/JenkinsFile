pipeline {

  ////////////////////////////////////////////////////////////////////////////
  // AGENT DOCKER POUR MAVEN + SONAR + DOCKER BUILDS
  ////////////////////////////////////////////////////////////////////////////
  agent {
    docker {
      image 'kingsylver/maven-jenkins-agent:v3'
      args '--user root -v /var/run/docker.sock:/var/run/docker.sock'
    }
  }

  ////////////////////////////////////////////////////////////////////////////
  // VARIABLES GLOBALES
  ////////////////////////////////////////////////////////////////////////////
  environment {
    DOCKER_IMAGE = "kingsylver/images-cicd:${BUILD_NUMBER}"
    GIT_REPO_NAME = "devops-jenkins"
    GIT_USER_NAME = "kingsylver2024"
    // SONAR_URL vient de Jenkins (global env var)
  }

  ////////////////////////////////////////////////////////////////////////////
  // PIPELINE STEPS
  ////////////////////////////////////////////////////////////////////////////
  stages {
    /////////////////////////////////////////////////////////
    // 0. CHECKOUT GIT
    /////////////////////////////////////////////////////////
    stage('0. Checkout') {
      steps {
        git branch: 'main', url: "https://github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git"
      }
    }

    /////////////////////////////////////////////////////////
    // 1. MAVEN BUILD
    /////////////////////////////////////////////////////////
    stage('1. Build et Tests (Maven)') {
      steps {
        sh """
          cd spring-boot-app
          mvn clean package
        """
      }
    }

    /////////////////////////////////////////////////////////
    // 2. ANALYSE SONARQUBE
    /////////////////////////////////////////////////////////
    stage('2. Analyse Statique SonarQube') {
      steps {
        withCredentials([string(credentialsId: 'sonarqube', variable: 'SONAR_AUTH_TOKEN')]) {
          sh """
            cd spring-boot-app
            mvn sonar:sonar \
              -Dsonar.login=$SONAR_AUTH_TOKEN \
              -Dsonar.host.url=${env.SONAR_URL}
          """
        }
      }
    }

    /////////////////////////////////////////////////////////
    // 3. DOCKER BUILD & PUSH
    /////////////////////////////////////////////////////////
    stage('3. Build et Push Docker') {
      steps {
        script {
          sh """
            cd spring-boot-app
            docker build -t ${DOCKER_IMAGE} .
          """

          docker.withRegistry('https://index.docker.io/v1/', "docker-cred") {
            docker.image("${DOCKER_IMAGE}").push()
          }

          // TAG latest
          sh "docker tag ${DOCKER_IMAGE} kingsylver/images-cicd:latest"

          docker.withRegistry('https://index.docker.io/v1/', "docker-cred") {
            docker.image("kingsylver/images-cicd:latest").push()
          }
        }
      }
    }

    /////////////////////////////////////////////////////////
    // 4. UPDATE K8S MANIFEST (HORS DOCKER - TRÃˆS IMPORTANT)
    /////////////////////////////////////////////////////////
    stage('4. Mise Ã  jour du manifeste Kubernetes') {
      agent none   // <-- indispensable
      steps {
        withCredentials([string(credentialsId: 'github', variable: 'GITHUB_TOKEN')]) {
          sh """
            set -e

            REPO_DIR="\$WORKSPACE/temp-gitops-repo"
            rm -rf "\$REPO_DIR"
            mkdir -p "\$REPO_DIR"

            git clone https://github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git "\$REPO_DIR"
            cd "\$REPO_DIR"

            git config user.email "kingsylver2009@gmail.com"
            git config user.name "kingsylver2024"

            sed -i "s#image: kingsylver/images-cicd:.*#image: kingsylver/images-cicd:${BUILD_NUMBER}#" \
              spring-boot-app-manifests/deployment.yml

            git add spring-boot-app-manifests/deployment.yml

            if git diff --staged --quiet; then
              echo "Aucun changement â†’ rien Ã  pousser"
              exit 0
            fi

            git commit -m "Deploy v${BUILD_NUMBER} (build #${BUILD_NUMBER})"
            git push https://${GITHUB_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git HEAD:main

            echo "Push rÃ©ussi ! ArgoCD va dÃ©ployer la v${BUILD_NUMBER}"
          """
        }
      }
    }

  } // end stages

  ////////////////////////////////////////////////////////////////////////////
  // NOTIFICATIONS SLACK # Token = r0triwKymta6atxs6LARG0y8
  ////////////////////////////////////////////////////////////////////////////
  post {

    success {
      slackSend(
        channel: '#devops-jenkins-cicd',
        color: '#36a64f',
        message: "ðŸŽ‰ SUCCESS â€” Build #${BUILD_NUMBER} dÃ©ployÃ© avec succÃ¨s ! ðŸš€"
      )
    }

    failure {
      slackSend(
        channel: '#devops-jenkins-cicd',
        color: '#ff0000',
        message: "âŒ FAILURE â€” Le pipeline #${BUILD_NUMBER} a Ã©chouÃ© ! âš ï¸"
      )
    }

  } // end post

} // end pipeline
